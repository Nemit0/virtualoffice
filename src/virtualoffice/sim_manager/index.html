<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VDOS Dashboard</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>

<body>
  <header>
    <div style="display: flex; align-items: center; gap: 12px;">
      <h1 style="margin: 0;">VDOS Dashboard</h1>
      <span id="header-replay-indicator" style="display: none; background: #f59e0b; color: white; padding: 4px 12px; border-radius: 4px; font-size: 13px; font-weight: 600;">
        REPLAY MODE
      </span>
    </div>
    <div id="status-message"></div>
  </header>

  <main>
    <nav class="tabs" role="tablist" aria-label="Dashboard sections">
      <button class="tab-button active" data-tab="controls" role="tab" aria-selected="true"
        aria-controls="control-panel" id="tab-controls-button">Controls</button>
      <button class="tab-button" data-tab="emails" role="tab" aria-selected="false" aria-controls="tab-emails"
        id="tab-emails-button">Emails</button>
      <button class="tab-button" data-tab="chat" role="tab" aria-selected="false" aria-controls="tab-chat"
        id="tab-chat-button">Chat</button>
      <button class="tab-button" data-tab="replay" role="tab" aria-selected="false" aria-controls="tab-replay"
        id="tab-replay-button">Replay</button>
      <button class="tab-button" data-tab="clusters" role="tab" aria-selected="false" aria-controls="tab-clusters"
        id="tab-clusters-button">üìä Email Clusters</button>
    </nav>
    <section id="control-panel">
      <h2>Controls</h2>
      <div class="controls-grid">
        <div class="card">
          <h3>Projects</h3>
          <div id="projects-list"></div>
          <div class="toolbar">
            <button id="add-project-btn">Add Project</button>
            <button id="export-projects-btn" class="secondary">Export Projects</button>
            <button id="import-projects-btn" class="secondary">Import Projects</button>
          </div>

          <hr style="margin: 20px 0;">

          <div class="form-row">
            <div class="form-group">
              <label for="random-seed">Random Seed (optional)</label>
              <input id="random-seed" type="number" />
            </div>
            <div class="form-group">
              <label for="model-hint">Model Hint (optional)</label>
              <input id="model-hint" type="text" placeholder="gpt-4o-mini" />
            </div>
          </div>
          <div class="toolbar">
            <button id="start-btn">Start Simulation</button>
            <button id="stop-btn" class="secondary">Stop</button>
            <button id="reset-btn" class="secondary">Reset</button>
            <button id="full-reset-btn" class="secondary">Full Reset (Delete Personas)</button>
          </div>
        </div>

        <div class="card">
          <div class="form-row">
            <div class="form-group">
              <label for="advance-ticks">Advance ticks</label>
              <input id="advance-ticks" type="number" min="1" value="1" />
            </div>
            <div class="form-group">
              <label for="advance-reason">Reason</label>
              <input id="advance-reason" type="text" value="manual" />
            </div>
            <div class="form-group">
              <label for="tick-interval">Auto-tick interval (seconds)</label>
              <input id="tick-interval" type="number" min="0" max="60" step="0.1" value="1.0" />
              <small style="color: #64748b; font-size: 11px;">0 = max speed (no delay)</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="auto-pause-toggle">
                <input id="auto-pause-toggle" type="checkbox" checked aria-describedby="auto-pause-help" />
                Auto-pause when projects complete
              </label>
              <small id="auto-pause-help" style="color: #64748b; font-size: 11px;">Automatically stops auto-tick when
                all projects are finished</small>
            </div>
            <div class="form-group">
              <label for="auto-refresh-toggle">
                <input id="auto-refresh-toggle" type="checkbox" checked aria-describedby="auto-refresh-help" />
                Auto-refresh dashboard
              </label>
              <small id="auto-refresh-help" style="color: #64748b; font-size: 11px;">Automatically refreshes all tabs
                (Controls, Emails, Chat) during simulation</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="style-filter-toggle">
                <input id="style-filter-toggle" type="checkbox" checked aria-describedby="style-filter-help" />
                Enable communication style filter
                <span id="style-filter-status" class="badge enabled">Enabled</span>
              </label>
              <small id="style-filter-help" style="color: #64748b; font-size: 11px;">Apply persona-specific communication styles to all emails and chats using GPT-4o</small>
            </div>
          </div>
          <div class="toolbar">
            <button id="advance-btn">Advance</button>
            <button id="auto-start-btn">Start Auto</button>
            <button id="auto-stop-btn" class="secondary">Stop Auto</button>
            <button id="refresh-btn">Refresh</button>
          </div>
        </div>
      </div>
    </section>

    <section id="state-panel">
      <h2>Simulation State</h2>

      <!-- Replay Mode Indicator -->
      <div id="replay-mode-indicator" class="replay-mode-indicator" style="display: none;">
        <div class="replay-icon">üîÑ</div>
        <div class="replay-text">
          <strong>REPLAY MODE</strong><br>
          <span id="replay-indicator-time">Viewing Day 1, 09:00</span>
        </div>
        <button id="replay-indicator-reset-btn" class="secondary">Return to Live Mode</button>
      </div>

      <div class="simulation-state">
        <div class="state-item">
          <strong>Status</strong><br>
          <span id="state-status">‚Äî</span>
        </div>
        <div class="state-item">
          <strong>Current Tick</strong><br>
          <span id="state-current_tick">0</span>
        </div>
        <div class="state-item">
          <strong>Simulation Time</strong><br>
          <span id="state-sim_time">Day 0 00:00</span>
        </div>
        <div class="state-item">
          <strong>Project Week</strong><br>
          <span id="state-project_week" title="Week calculated using 8-hour workdays for project scheduling">‚Äî</span>
        </div>
        <div class="state-item">
          <strong>Auto Tick</strong><br>
          <span id="state-auto">False</span>
        </div>
        <div class="state-item">
          <strong>Auto-Pause</strong><br>
          <span id="state-auto-pause">‚Äî</span>
        </div>
        <div class="state-item">
          <strong>Active Projects</strong><br>
          <span id="state-active-projects">‚Äî</span>
        </div>
        <div class="state-item">
          <strong>Future Projects</strong><br>
          <span id="state-future-projects">‚Äî</span>
        </div>
      </div>
      <div id="auto-pause-warning" class="auto-pause-warning" style="display: none;">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <div class="warning-text">
          <strong>Auto-pause will trigger soon</strong><br>
          <span id="auto-pause-warning-text">No active projects remaining</span>
        </div>
      </div>
    </section>

    <section id="active-projects-section">
      <h2>Active Project Assignments</h2>
      <p>Teams currently working on projects. Project scheduling uses <strong>8-hour workdays</strong> (5-day weeks) - see "Project Week" above for current week.</p>
      <div id="active-projects-container"></div>
    </section>

    <section id="people-section">
      <h2>Personas</h2>
      <p>Select personas to include in the next simulation run.</p>
      <div class="toolbar">
        <button id="export-personas-btn" class="secondary">Export Personas</button>
        <button id="import-personas-btn" class="secondary">Import Personas</button>
      </div>
      <div id="people-container"></div>
    </section>

    <section id="persona-section">
      <h2>Create Persona</h2>
      <div class="controls-grid">
        <div class="card">
          <div class="form-group">
            <label for="persona-prompt">Prompt</label>
            <input id="persona-prompt" type="text" placeholder="Full stack developer focused on dashboards" />
          </div>
          <div class="toolbar">
            <button id="persona-generate-btn">Generate with GPT</button>
          </div>
        </div>

        <div class="card">
          <div class="form-row">
            <div class="form-group">
              <label for="persona-name">Name</label>
              <input id="persona-name" type="text" />
            </div>
            <div class="form-group">
              <label for="persona-role">Role</label>
              <input id="persona-role" type="text" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="persona-timezone">Timezone</label>
              <input id="persona-timezone" type="text" value="UTC" />
            </div>
            <div class="form-group">
              <label for="persona-hours">Work hours</label>
              <input id="persona-hours" type="text" value="09:00-17:00" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="persona-break">Break frequency</label>
              <input id="persona-break" type="text" value="50/10 cadence" />
            </div>
            <div class="form-group">
              <label for="persona-style">Communication style</label>
              <input id="persona-style" type="text" value="Warm async" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="persona-email">Email address</label>
              <input id="persona-email" type="text" placeholder="name@vdos.local" />
            </div>
            <div class="form-group">
              <label for="persona-chat">Chat handle</label>
              <input id="persona-chat" type="text" placeholder="handle" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="persona-team">Team name (optional)</label>
              <input id="persona-team" type="text" placeholder="e.g., Team A, ÌåÄA" />
            </div>
            <div class="form-group">
              <label>
                <input id="persona-is-head" type="checkbox" /> Department head
              </label>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="form-group">
            <label for="persona-skills">Skills (comma separated)</label>
            <input id="persona-skills" type="text" />
          </div>
          <div class="form-group">
            <label for="persona-personality">Personality (comma separated)</label>
            <input id="persona-personality" type="text" />
          </div>
          <div class="form-group">
            <label for="persona-objectives">Objectives (one per line)</label>
            <textarea id="persona-objectives"></textarea>
          </div>
          <div class="form-group">
            <label for="persona-metrics">Metrics (one per line)</label>
            <textarea id="persona-metrics"></textarea>
          </div>
          <div class="form-group">
            <label for="persona-guidelines">Planning guidelines (one per line)</label>
            <textarea id="persona-guidelines"></textarea>
          </div>
        </div>

        <div class="card">
          <div class="form-group">
            <label for="persona-schedule">Schedule (HH:MM-HH:MM Activity per line)</label>
            <textarea id="persona-schedule"></textarea>
          </div>
          <div class="form-group">
            <label for="persona-playbook">Event playbook (JSON object)</label>
            <textarea id="persona-playbook"></textarea>
          </div>
          <div class="form-group">
            <label for="persona-statuses">Statuses (one per line)</label>
            <textarea id="persona-statuses"></textarea>
          </div>
        </div>

        <div class="card">
          <h3>Communication Style Examples</h3>
          <p class="small">
            These examples define how this persona writes emails and chats.
            The style filter uses these to transform generated messages.
          </p>

          <div class="form-group">
            <label for="style-example-0">Email Example 1</label>
            <textarea id="style-example-0" rows="3"
              placeholder="Example of how this persona writes formal emails..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-1">Email Example 2</label>
            <textarea id="style-example-1" rows="3"
              placeholder="Another email example showing this persona's style..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-2">Email Example 3</label>
            <textarea id="style-example-2" rows="3" placeholder="A third email example..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-3">Email Example 4</label>
            <textarea id="style-example-3" rows="3" placeholder="A fourth email example..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-4">Email Example 5</label>
            <textarea id="style-example-4" rows="3" placeholder="A fifth email example..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-5">Chat Example 1</label>
            <textarea id="style-example-5" rows="3"
              placeholder="Example of how this persona writes in chat..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-6">Chat Example 2</label>
            <textarea id="style-example-6" rows="3" placeholder="Another chat example..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-7">Chat Example 3</label>
            <textarea id="style-example-7" rows="3" placeholder="A third chat example..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-8">Chat Example 4</label>
            <textarea id="style-example-8" rows="3" placeholder="A fourth chat example..."></textarea>
          </div>

          <div class="form-group">
            <label for="style-example-9">Chat Example 5</label>
            <textarea id="style-example-9" rows="3" placeholder="A fifth chat example..."></textarea>
          </div>

          <div class="toolbar">
            <button id="regenerate-examples-btn" class="secondary">Regenerate with AI</button>
            <button id="preview-filter-btn" class="secondary">Preview Filter</button>
          </div>
        </div>

        <div class="card">
          <div class="toolbar">
            <button id="persona-create-btn">Create Persona</button>
            <button id="persona-clear-btn" class="secondary">Clear</button>
          </div>
        </div>
      </div>
    </section>

    <section id="plans-section">
      <h2>Plans & Reports</h2>
      <div id="plans-container"></div>
    </section>

    <section id="metrics-section">
      <h2>Planner Metrics</h2>
      <div style="overflow-x: auto;">
        <table id="planner-table">
          <thead>
            <tr>
              <th>Time (UTC)</th>
              <th>Method</th>
              <th>Planner</th>
              <th>Model</th>
              <th>Duration (ms)</th>
              <th>Fallback</th>
              <th>Context</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="token-section">
      <h2>Token Usage</h2>
      <div style="overflow-x: auto;">
        <table id="token-table">
          <thead>
            <tr>
              <th>Model</th>
              <th>Tokens</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="events-section">
      <h2>Recent Events</h2>
      <ul id="events-list"></ul>
    </section>

    <!-- Emails Tab -->
    <section id="tab-emails" class="tabbed-section" style="display: none;" role="tabpanel"
      aria-labelledby="tab-emails-button">
      <h2 id="email-tab-heading">Emails</h2>

      <!-- Email Client Header -->
      <div class="email-client-header" role="toolbar" aria-label="Email client controls">
        <div class="email-client-controls">
          <div class="form-group">
            <label for="email-person-select">Persona</label>
            <select id="email-person-select" aria-describedby="email-person-help">
              <option value="">Select a persona...</option>
            </select>
            <div id="email-person-help" class="sr-only">Choose which persona's emails to view</div>
          </div>

          <div class="email-folder-navigation" role="tablist" aria-label="Email folders">
            <div class="segmented">
              <button id="email-folder-inbox" class="seg active" role="tab" aria-selected="true"
                aria-controls="email-list" tabindex="0">Inbox</button>
              <button id="email-folder-sent" class="seg" role="tab" aria-selected="false" aria-controls="email-list"
                tabindex="-1">Sent</button>
            </div>
          </div>
        </div>

        <div class="email-client-actions">
          <button id="email-refresh-btn" class="secondary" aria-describedby="email-refresh-help">
            <span aria-hidden="true">üîÑ</span> Refresh
          </button>
          <div id="email-refresh-help" class="sr-only">Refresh email list (Shortcut: R)</div>
          <div class="email-status-indicator" role="status" aria-live="polite">
            <span id="email-last-refresh">Never refreshed</span>
          </div>
        </div>
      </div>

      <!-- Email Client Body - Two Pane Layout -->
      <div class="email-client-body" role="main" aria-label="Email client interface">
        <div class="email-client-layout">
          <!-- Email List Pane -->
          <div class="email-list-pane" role="region" aria-labelledby="email-list-heading">
            <div class="email-list-header">
              <div class="email-list-title">
                <h3 id="email-list-heading">
                  <span id="email-folder-title">Inbox</span>
                  <span id="email-count" class="email-count-badge" aria-label="email count">0</span>
                </h3>
              </div>
              <div class="email-search-container">
                <input type="text" id="email-search" class="email-search-input" placeholder="Search emails..."
                  aria-label="Search emails" />
                <button id="email-search-clear" class="email-search-clear" aria-label="Clear search"
                  style="display: none;">√ó</button>
              </div>
            </div>
            <div class="email-list-container">
              <div id="email-list" class="email-list" tabindex="0" aria-describedby="email-list-help">
                <!-- Email rows will be populated here -->
                <div class="email-list-placeholder">
                  <div class="placeholder-icon" aria-hidden="true">üìß</div>
                  <div class="placeholder-text">
                    <p>Select a persona to view emails</p>
                  </div>
                </div>
              </div>
              <div id="email-list-help" class="sr-only">Use arrow keys to navigate emails, Enter to select, R to
                refresh, I for Inbox, S for Sent</div>
            </div>
          </div>

          <!-- Email Detail Pane -->
          <div class="email-detail-pane" role="region" aria-labelledby="email-detail-heading">
            <div class="email-detail-container">
              <div id="email-detail" class="email-detail-view" aria-live="polite">
                <!-- Email detail content will be populated here -->
                <div class="email-detail-placeholder">
                  <div class="placeholder-icon" aria-hidden="true">‚úâÔ∏è</div>
                  <div class="placeholder-text">
                    <h3 id="email-detail-heading">No email selected</h3>
                    <p>Select an email from the list to view its contents</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Chat Tab -->
    <section id="tab-chat" class="tabbed-section" style="display: none;" role="tabpanel"
      aria-labelledby="tab-chat-button">
      <h2 id="chat-tab-heading">Chat</h2>

      <!-- Chat Client Header -->
      <div class="chat-client-header" role="toolbar" aria-label="Chat client controls">
        <div class="chat-client-controls">
          <div class="form-group">
            <label for="chat-person-select">Persona</label>
            <select id="chat-person-select" aria-describedby="chat-person-help">
              <option value="">Select a persona...</option>
            </select>
            <div id="chat-person-help" class="sr-only">Choose which persona's chat conversations to view</div>
          </div>
        </div>

        <div class="chat-client-actions">
          <button id="chat-sidebar-toggle" class="chat-sidebar-toggle" aria-describedby="chat-sidebar-toggle-help">
            <span class="toggle-icon" aria-hidden="true">‚ò∞</span> Menu
          </button>
          <div id="chat-sidebar-toggle-help" class="sr-only">Toggle conversation sidebar</div>
          <button id="chat-refresh-btn" class="secondary" aria-describedby="chat-refresh-help">
            <span aria-hidden="true">üîÑ</span> Refresh
          </button>
          <div id="chat-refresh-help" class="sr-only">Refresh chat conversations</div>
          <div class="chat-status-indicator" role="status" aria-live="polite">
            <span id="chat-last-refresh">Never refreshed</span>
          </div>
        </div>
      </div>

      <!-- Chat Client Body - Two Pane Layout -->
      <div class="chat-client-body" role="main" aria-label="Chat client interface">
        <!-- Mobile sidebar overlay -->
        <div class="chat-sidebar-overlay" id="chat-sidebar-overlay" aria-hidden="true"></div>
        <div class="chat-client-layout" id="chat-client-layout">
          <!-- Chat Sidebar Pane -->
          <div class="chat-sidebar-pane" role="region" aria-labelledby="chat-sidebar-heading">
            <div class="chat-sidebar">
              <div class="chat-sidebar-header">
                <h3 id="chat-sidebar-heading" class="sr-only">Conversations</h3>
                <div class="chat-search-container">
                  <input type="text" id="chat-search" class="chat-search-input" placeholder="Search conversations..."
                    aria-label="Search conversations" />
                  <button id="chat-search-clear" class="chat-search-clear" aria-label="Clear search"
                    style="display: none;">√ó</button>
                </div>
              </div>
              <div class="chat-sidebar-content">
                <div class="conversation-section" id="rooms-section">
                  <h4 class="section-title">
                    <span class="section-icon" aria-hidden="true">#</span>
                    Rooms
                    <span class="section-count" id="rooms-count">(0)</span>
                  </h4>
                  <div class="conversation-list" id="chat-rooms-list" role="list" aria-label="Chat rooms">
                    <!-- Room conversation items will be populated here -->
                  </div>
                </div>
                <div class="conversation-section" id="dms-section">
                  <h4 class="section-title">
                    <span class="section-icon" aria-hidden="true">@</span>
                    Direct Messages
                    <span class="section-count" id="dms-count">(0)</span>
                  </h4>
                  <div class="conversation-list" id="chat-dms-list" role="list" aria-label="Direct messages">
                    <!-- DM conversation items will be populated here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat Message Pane -->
          <div class="chat-message-pane" role="region" aria-labelledby="chat-message-heading">
            <div class="chat-message-view">
              <div class="chat-message-header">
                <div class="conversation-title">
                  <h3 id="chat-message-heading" class="conversation-name">Select a conversation</h3>
                  <div class="conversation-meta">
                    <span class="participant-list"></span>
                    <span class="message-count"></span>
                  </div>
                </div>
                <div class="message-actions">
                  <div class="message-search-container">
                    <input type="text" id="message-search" class="message-search"
                      placeholder="Search in conversation..." aria-label="Search messages in current conversation" />
                    <div class="message-search-controls" id="message-search-controls" style="display: none;">
                      <span class="search-results-count" id="search-results-count"></span>
                      <button id="search-prev-btn" class="search-nav-btn" aria-label="Previous search result"
                        title="Previous (Shift+Enter)">‚Üë</button>
                      <button id="search-next-btn" class="search-nav-btn" aria-label="Next search result"
                        title="Next (Enter)">‚Üì</button>
                      <button id="search-clear-btn" class="search-clear-btn" aria-label="Clear search"
                        title="Clear (Escape)">‚úï</button>
                    </div>
                  </div>
                  <button id="message-refresh-btn" class="message-refresh-btn secondary"
                    aria-label="Refresh messages">üîÑ</button>
                </div>
              </div>

              <div class="chat-message-content">
                <div class="message-thread" id="message-thread" role="log" aria-live="polite"
                  aria-label="Message thread">
                  <!-- Message bubbles will be populated here -->
                  <div class="message-thread-placeholder">
                    <div class="placeholder-icon" aria-hidden="true">üí¨</div>
                    <div class="placeholder-text">
                      <h4>No conversation selected</h4>
                      <p>Select a conversation from the sidebar to view messages</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="chat-message-footer">
                <div class="message-status">
                  Last updated: <span id="chat-message-last-refresh">Never</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Replay Tab (Time Machine) -->
    <section id="tab-replay" class="tabbed-section" style="display: none;" role="tabpanel"
      aria-labelledby="tab-replay-button">
      <h2>Time Machine - Replay Controls</h2>
      
      <p style="margin-bottom: 16px; color: #64748b;">
        Jump to any previously generated tick to view historical emails and chats.
        Use the controls below to navigate through simulation time.
      </p>

      <div class="replay-container">
        <!-- Replay Controls Card -->
        <div class="card">
          <h3>Jump Controls</h3>

          <div class="replay-info">
            <div class="info-row">
              <span class="label">Current Tick:</span>
              <span id="replay-current-tick" class="value">-</span>
            </div>
            <div class="info-row">
              <span class="label">Max Generated Tick:</span>
              <span id="replay-max-tick" class="value">-</span>
            </div>
            <div class="info-row">
              <span class="label">Mode:</span>
              <span id="replay-mode" class="value badge">Live</span>
            </div>
          </div>

          <hr style="margin: 20px 0;">

          <div class="form-row">
            <div class="form-group">
              <label for="replay-jump-day">Day</label>
              <input id="replay-jump-day" type="number" min="1" value="1" />
            </div>
            <div class="form-group">
              <label for="replay-jump-hour">Hour (0-23)</label>
              <input id="replay-jump-hour" type="number" min="0" max="23" value="9" />
            </div>
            <div class="form-group">
              <label for="replay-jump-minute">Minute (0-59)</label>
              <input id="replay-jump-minute" type="number" min="0" max="59" value="0" />
            </div>
          </div>

          <div class="toolbar">
            <button id="replay-jump-btn">Jump to Time</button>
            <button id="replay-reset-btn" class="secondary">Reset to Live Mode</button>
          </div>

          <div id="replay-error" style="display: none; margin-top: 12px; padding: 12px; background: #fee; border-radius: 4px; color: #b91c1c;"></div>
        </div>

        <!-- Current State Card -->
        <div class="card">
          <h3>Current State <span id="replay-state-time" style="color: #64748b; font-size: 14px; font-weight: normal;"></span></h3>

          <div class="tabs-secondary">
            <button class="tab-button-secondary active" data-tab-secondary="replay-emails">Emails</button>
            <button class="tab-button-secondary" data-tab-secondary="replay-chats">Chats</button>
          </div>

          <div id="replay-emails-content" class="replay-content">
            <div id="replay-emails-list">
              <p style="color: #64748b; text-align: center; padding: 20px;">
                Click "Jump to Time" to load emails at that tick
              </p>
            </div>
          </div>

          <div id="replay-chats-content" class="replay-content" style="display: none;">
            <div id="replay-chats-list">
              <p style="color: #64748b; text-align: center; padding: 20px;">
                Click "Jump to Time" to load chats at that tick
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Email Clusters Tab -->
    <section id="tab-clusters" class="tabbed-section" style="display: none;" role="tabpanel"
      aria-labelledby="tab-clusters-button">
      <h2>üìä Email Cluster Visualization</h2>

      <p style="margin-bottom: 16px; color: #64748b;">
        Visualize email patterns and discover communication clusters using AI-powered embeddings and t-SNE dimensionality reduction.
      </p>

      <div class="clustering-container">
        <!-- Controls Card -->
        <div class="card">
          <h3>Controls</h3>

          <div class="form-group">
            <label for="cluster-persona-select">Select Persona</label>
            <select id="cluster-persona-select">
              <option value="">Loading personas...</option>
            </select>
          </div>

          <!-- Clustering Parameters -->
          <div style="margin: 16px 0; padding: 16px; background: #f8fafc; border-radius: 4px; border: 1px solid #e2e8f0;">
            <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Clustering Parameters</h4>

            <div class="form-group" style="margin-bottom: 12px;">
              <label for="dbscan-eps" style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>DBSCAN Epsilon (eps)</span>
                <span id="dbscan-eps-value" style="color: #3b82f6; font-weight: 600;">10.0</span>
              </label>
              <input type="range" id="dbscan-eps" min="1.0" max="30.0" step="0.5" value="10.0"
                     style="width: 100%;" title="Distance threshold for clustering. Higher = larger clusters">
              <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Distance threshold (try 8-15 for most datasets)</div>
            </div>

            <div class="form-group" style="margin-bottom: 12px;">
              <label for="dbscan-min-samples" style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>Min Samples per Cluster</span>
                <span id="dbscan-min-samples-value" style="color: #3b82f6; font-weight: 600;">3</span>
              </label>
              <input type="range" id="dbscan-min-samples" min="2" max="10" step="1" value="3"
                     style="width: 100%;" title="Minimum points to form a cluster">
              <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Minimum points to form a cluster</div>
            </div>

            <div class="form-group">
              <label for="tsne-perplexity" style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>t-SNE Perplexity</span>
                <span id="tsne-perplexity-value" style="color: #3b82f6; font-weight: 600;">30</span>
              </label>
              <input type="range" id="tsne-perplexity" min="5" max="50" step="5" value="30"
                     style="width: 100%;" title="Balances local vs global structure">
              <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Balances local vs global structure in visualization</div>
            </div>
          </div>

          <!-- Auto-Optimization -->
          <div style="margin: 16px 0; padding: 16px; background: #f0f9ff; border-radius: 4px; border: 1px solid #bae6fd;">
            <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #0369a1;">ü§ñ Auto-Optimize Parameters</h4>

            <div class="form-group" style="margin-bottom: 12px;">
              <label for="cluster-optimize-guideline" style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">
                Clustering Goal (Natural Language)
              </label>
              <input
                type="text"
                id="cluster-optimize-guideline"
                placeholder="e.g., 'Group by intent', 'Organize by project', 'Categorize by topic'"
                style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px;"
              />
              <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                Tell GPT what kind of clusters you want. Leave blank for general categorization.
              </div>
            </div>

            <button
              id="cluster-auto-optimize-btn"
              style="width: 100%; padding: 10px; background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%); color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
              onmouseover="this.style.opacity='0.9'"
              onmouseout="this.style.opacity='1'"
            >
              ‚ú® Auto-Optimize with GPT
            </button>

            <div style="font-size: 11px; color: #64748b; margin-top: 8px; text-align: center;">
              Tests multiple configurations and uses GPT to find the best clustering
            </div>
          </div>

          <div id="cluster-status-info" style="margin: 16px 0; padding: 12px; background: #f8fafc; border-radius: 4px; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>Status:</strong> <span id="cluster-status-text">Not indexed</span><br>
                <span id="cluster-status-details" style="color: #64748b; font-size: 13px;"></span>
              </div>
              <button id="cluster-index-btn" style="margin-left: 12px;">üîÑ Index Data</button>
            </div>
          </div>

          <div id="cluster-progress" style="display: none; margin: 16px 0;">
            <div style="margin-bottom: 8px;">
              <strong>Indexing Progress</strong>
              <span id="cluster-progress-percent" style="float: right;">0%</span>
            </div>
            <div style="width: 100%; height: 24px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
              <div id="cluster-progress-bar" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s;"></div>
            </div>
            <div id="cluster-progress-step" style="margin-top: 8px; color: #64748b; font-size: 13px;">Initializing...</div>
          </div>

          <!-- Cluster Statistics -->
          <div id="cluster-stats" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 4px;">
            <h4 style="margin: 0 0 12px 0;">Statistics</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <div style="color: #64748b; font-size: 12px;">Total Emails</div>
                <div style="font-size: 20px; font-weight: 600;" id="stat-total-emails">-</div>
              </div>
              <div>
                <div style="color: #64748b; font-size: 12px;">Clusters</div>
                <div style="font-size: 20px; font-weight: 600;" id="stat-num-clusters">-</div>
              </div>
              <div>
                <div style="color: #64748b; font-size: 12px;">Noise Points</div>
                <div style="font-size: 20px; font-weight: 600;" id="stat-noise-points">-</div>
              </div>
              <div>
                <div style="color: #64748b; font-size: 12px;">Avg Cluster Size</div>
                <div style="font-size: 20px; font-weight: 600;" id="stat-avg-size">-</div>
              </div>
            </div>
          </div>

          <!-- Cluster List -->
          <div id="cluster-list" style="display: none; margin-top: 16px;">
            <h4 style="margin: 0 0 12px 0;">Clusters</h4>
            <div id="cluster-list-items" style="max-height: 300px; overflow-y: auto;">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Visualization Card -->
        <div class="card" style="flex: 2;">
          <h3>3D Visualization</h3>

          <div id="cluster-viz-placeholder" style="display: flex; align-items: center; justify-content: center; min-height: 500px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; color: #94a3b8; text-align: center; padding: 40px;">
            <div>
              <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No Visualization Available</div>
              <div style="font-size: 14px;">Select a persona and click "Index Data" to build the cluster visualization</div>
            </div>
          </div>

          <div id="cluster-visualization" style="display: none; width: 100%; height: 600px;">
            <!-- Plotly will render here -->
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Preview Filter Modal -->
  <div id="preview-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div
      style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 8px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <h2>Preview Communication Style Filter</h2>
      <p class="small">Enter a sample message to see how the style filter would transform it using this persona's
        examples.</p>

      <label for="preview-input">Sample Message</label>
      <textarea id="preview-input" rows="4" placeholder="Enter a sample message to transform..."></textarea>

      <div class="toolbar">
        <button id="preview-transform-btn">Transform</button>
        <button id="preview-close-btn" class="secondary">Close</button>
      </div>

      <div id="preview-results" style="display: none; margin-top: 20px;">
        <div style="margin-bottom: 16px;">
          <strong>Original Message:</strong>
          <pre id="preview-original"
            style="background: #f1f5f9; padding: 12px; border-radius: 4px; white-space: pre-wrap;"></pre>
        </div>
        <div>
          <strong>Filtered Message:</strong>
          <pre id="preview-filtered"
            style="background: #f1f5f9; padding: 12px; border-radius: 4px; white-space: pre-wrap;"></pre>
        </div>
      </div>

      <div id="preview-error" style="display: none; color: #b91c1c; margin-top: 12px;"></div>
    </div>
  </div>

  <!-- Email Modal Viewer -->
  <div id="email-modal" class="modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <div class="modal-header">
        <div class="modal-title" id="email-modal-subject">Subject</div>
        <button id="email-modal-close" class="secondary">Close</button>
      </div>
      <div class="modal-body" id="email-modal-body"></div>
    </div>
  </div>

  <!-- Plotly.js for 3D Visualizations -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <script>
    console.log('[INLINE TEST] JavaScript is working!');
    console.log('[INLINE TEST] Timestamp:', new Date().toISOString());

    // Performance monitoring for page load
    window.addEventListener('load', () => {
      const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
      console.log(`[PERF] Page load completed in ${loadTime}ms`);
      if (loadTime > 2000) {
        console.warn(`[PERF] Page load time (${loadTime}ms) exceeds target of 2000ms`);
      }
    });
  </script>
  <script type="module" src="/static/js/app.js"></script>
  <script type="module" src="/static/js/clustering.js"></script>
</body>

</html>