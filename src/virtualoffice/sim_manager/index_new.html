<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VDOS Dashboard</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
  <header>
    <h1>VDOS Dashboard</h1>
    <div id="status-message"></div>
  </header>

  <main>
    <nav class="tabs" role="tablist" aria-label="Dashboard sections">
      <button class="tab-button active" data-tab="controls" role="tab" aria-selected="true" aria-controls="control-panel" id="tab-controls-button">Controls</button>
      <button class="tab-button" data-tab="emails" role="tab" aria-selected="false" aria-controls="tab-emails" id="tab-emails-button">Emails</button>
      <button class="tab-button" data-tab="chat" role="tab" aria-selected="false" aria-controls="tab-chat" id="tab-chat-button">Chat</button>
    </nav>
    <section id="control-panel">
      <h2>Controls</h2>
      <div class="controls-grid">
        <div class="card">
          <h3>Projects</h3>
          <div id="projects-list"></div>
          <div class="toolbar">
            <button id="add-project-btn">Add Project</button>
            <button id="export-projects-btn" class="secondary">Export Projects</button>
            <button id="import-projects-btn" class="secondary">Import Projects</button>
          </div>

          <hr style="margin: 20px 0;">

          <div class="form-row">
            <div class="form-group">
              <label for="random-seed">Random Seed (optional)</label>
              <input id="random-seed" type="number"/>
            </div>
            <div class="form-group">
              <label for="model-hint">Model Hint (optional)</label>
              <input id="model-hint" type="text" placeholder="gpt-4o-mini"/>
            </div>
          </div>
          <div class="toolbar">
            <button id="start-btn">Start Simulation</button>
            <button id="stop-btn" class="secondary">Stop</button>
            <button id="reset-btn" class="secondary">Reset</button>
            <button id="full-reset-btn" class="secondary">Full Reset (Delete Personas)</button>
          </div>
        </div>

        <div class="card">
          <div class="form-row">
            <div class="form-group">
              <label for="advance-ticks">Advance ticks</label>
              <input id="advance-ticks" type="number" min="1" value="1"/>
            </div>
            <div class="form-group">
              <label for="advance-reason">Reason</label>
              <input id="advance-reason" type="text" value="manual"/>
            </div>
            <div class="form-group">
              <label for="tick-interval">Auto-tick interval (seconds)</label>
              <input id="tick-interval" type="number" min="0" max="60" step="0.1" value="1.0"/>
              <small style="color: #64748b; font-size: 11px;">0 = max speed (no delay)</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="auto-pause-toggle">
                <input id="auto-pause-toggle" type="checkbox" checked aria-describedby="auto-pause-help"/>
                Auto-pause when projects complete
              </label>
              <small id="auto-pause-help" style="color: #64748b; font-size: 11px;">Automatically stops auto-tick when all projects are finished</small>
            </div>
            <div class="form-group">
              <label for="auto-refresh-toggle">
                <input id="auto-refresh-toggle" type="checkbox" checked aria-describedby="auto-refresh-help"/>
                Auto-refresh dashboard
              </label>
              <small id="auto-refresh-help" style="color: #64748b; font-size: 11px;">Automatically refreshes all tabs (Controls, Emails, Chat) during simulation</small>
            </div>
          </div>
          <div class="toolbar">
            <button id="advance-btn">Advance</button>
            <button id="auto-start-btn">Start Auto</button>
            <button id="auto-stop-btn" class="secondary">Stop Auto</button>
            <button id="refresh-btn">Refresh</button>
          </div>
        </div>
      </div>
    </section>

    <section id="state-panel">
      <h2>Simulation State</h2>
      <div class="simulation-state">
        <div class="state-item">
          <strong>Status</strong><br>
          <span id="state-status">—</span>
        </div>
        <div class="state-item">
          <strong>Current Tick</strong><br>
          <span id="state-current_tick">0</span>
        </div>
        <div class="state-item">
          <strong>Simulation Time</strong><br>
          <span id="state-sim_time">Day 0 00:00</span>
        </div>
        <div class="state-item">
          <strong>Auto Tick</strong><br>
          <span id="state-auto">False</span>
        </div>
        <div class="state-item">
          <strong>Auto-Pause</strong><br>
          <span id="state-auto-pause">—</span>
        </div>
        <div class="state-item">
          <strong>Active Projects</strong><br>
          <span id="state-active-projects">—</span>
        </div>
        <div class="state-item">
          <strong>Future Projects</strong><br>
          <span id="state-future-projects">—</span>
        </div>
      </div>
      <div id="auto-pause-warning" class="auto-pause-warning" style="display: none;">
        <div class="warning-icon">⚠️</div>
        <div class="warning-text">
          <strong>Auto-pause will trigger soon</strong><br>
          <span id="auto-pause-warning-text">No active projects remaining</span>
        </div>
      </div>
    </section>

    <section id="active-projects-section">
      <h2>Active Project Assignments</h2>
      <p>Teams currently working on projects (based on simulation week and project timelines).</p>
      <div id="active-projects-container"></div>
    </section>

    <section id="people-section">
      <h2>Personas</h2>
      <p>Select personas to include in the next simulation run.</p>
      <div class="toolbar">
        <button id="export-personas-btn" class="secondary">Export Personas</button>
        <button id="import-personas-btn" class="secondary">Import Personas</button>
      </div>
      <div id="people-container"></div>
    </section>

    <section id="persona-section">
      <h2>Create Persona</h2>
      <div class="controls-grid">
        <div class="card">
          <div class="form-group">
            <label for="persona-prompt">Prompt</label>
            <input id="persona-prompt" type="text" placeholder="Full stack developer focused on dashboards"/>
          </div>
          <div class="toolbar">
            <button id="persona-generate-btn">Generate with GPT</button>
          </div>
        </div>

        <div class="card">
          <div class="form-row">
            <div class="form-group">
              <label for="persona-name">Name</label>
              <input id="persona-name" type="text"/>
            </div>
            <div class="form-group">
              <label for="persona-role">Role</label>
              <input id="persona-role" type="text"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="persona-timezone">Timezone</label>
              <input id="persona-timezone" type="text" value="UTC"/>
            </div>
            <div class="form-group">
              <label for="persona-hours">Work hours</label>
              <input id="persona-hours" type="text" value="09:00-17:00"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="persona-break">Break frequency</label>
              <input id="persona-break" type="text" value="50/10 cadence"/>
            </div>
            <div class="form-group">
              <label for="persona-style">Communication style</label>
              <input id="persona-style" type="text" value="Warm async"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="persona-email">Email address</label>
              <input id="persona-email" type="text" placeholder="name@vdos.local"/>
            </div>
            <div class="form-group">
              <label for="persona-chat">Chat handle</label>
              <input id="persona-chat" type="text" placeholder="handle"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="persona-team">Team name (optional)</label>
              <input id="persona-team" type="text" placeholder="e.g., Team A, 팀A"/>
            </div>
            <div class="form-group">
              <label>
                <input id="persona-is-head" type="checkbox"/> Department head
              </label>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="form-group">
            <label for="persona-skills">Skills (comma separated)</label>
            <input id="persona-skills" type="text"/>
          </div>
          <div class="form-group">
            <label for="persona-personality">Personality (comma separated)</label>
            <input id="persona-personality" type="text"/>
          </div>
          <div class="form-group">
            <label for="persona-objectives">Objectives (one per line)</label>
            <textarea id="persona-objectives"></textarea>
          </div>
          <div class="form-group">
            <label for="persona-metrics">Metrics (one per line)</label>
            <textarea id="persona-metrics"></textarea>
          </div>
          <div class="form-group">
            <label for="persona-guidelines">Planning guidelines (one per line)</label>
            <textarea id="persona-guidelines"></textarea>
          </div>
        </div>

        <div class="card">
          <div class="form-group">
            <label for="persona-schedule">Schedule (HH:MM-HH:MM Activity per line)</label>
            <textarea id="persona-schedule"></textarea>
          </div>
          <div class="form-group">
            <label for="persona-playbook">Event playbook (JSON object)</label>
            <textarea id="persona-playbook"></textarea>
          </div>
          <div class="form-group">
            <label for="persona-statuses">Statuses (one per line)</label>
            <textarea id="persona-statuses"></textarea>
          </div>
          <div class="toolbar">
            <button id="persona-create-btn">Create Persona</button>
            <button id="persona-clear-btn" class="secondary">Clear</button>
          </div>
        </div>
      </div>
    </section>

    <section id="plans-section">
      <h2>Plans & Reports</h2>
      <div id="plans-container"></div>
    </section>

    <section id="metrics-section">
      <h2>Planner Metrics</h2>
      <div style="overflow-x: auto;">
        <table id="planner-table">
          <thead>
            <tr>
              <th>Time (UTC)</th>
              <th>Method</th>
              <th>Planner</th>
              <th>Model</th>
              <th>Duration (ms)</th>
              <th>Fallback</th>
              <th>Context</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="token-section">
      <h2>Token Usage</h2>
      <div style="overflow-x: auto;">
        <table id="token-table">
          <thead>
            <tr>
              <th>Model</th>
              <th>Tokens</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="events-section">
      <h2>Recent Events</h2>
      <ul id="events-list"></ul>
    </section>

    <!-- Emails Tab -->
    <section id="tab-emails" class="tabbed-section" style="display: none;" role="tabpanel" aria-labelledby="tab-emails-button">
      <h2 id="email-tab-heading">Emails</h2>
      
      <!-- Email Client Header -->
      <div class="email-client-header" role="toolbar" aria-label="Email client controls">
        <div class="email-client-controls">
          <div class="form-group">
            <label for="email-person-select">Persona</label>
            <select id="email-person-select" aria-describedby="email-person-help">
              <option value="">Select a persona...</option>
            </select>
            <div id="email-person-help" class="sr-only">Choose which persona's emails to view</div>
          </div>
          
          <div class="email-folder-navigation" role="tablist" aria-label="Email folders">
            <div class="segmented">
              <button id="email-folder-inbox" class="seg active" role="tab" aria-selected="true" aria-controls="email-list" tabindex="0">Inbox</button>
              <button id="email-folder-sent" class="seg" role="tab" aria-selected="false" aria-controls="email-list" tabindex="-1">Sent</button>
            </div>
          </div>
        </div>
        
        <div class="email-client-actions">
          <button id="email-refresh-btn" class="secondary" aria-describedby="email-refresh-help">
            <span aria-hidden="true">🔄</span> Refresh
          </button>
          <div id="email-refresh-help" class="sr-only">Refresh email list (Shortcut: R)</div>
          <div class="email-status-indicator" role="status" aria-live="polite">
            <span id="email-last-refresh">Never refreshed</span>
          </div>
        </div>
      </div>

      <!-- Email Client Body - Two Pane Layout -->
      <div class="email-client-body" role="main" aria-label="Email client interface">
        <div class="email-client-layout">
          <!-- Email List Pane -->
          <div class="email-list-pane" role="region" aria-labelledby="email-list-heading">
            <div class="email-list-header">
              <div class="email-list-title">
                <h3 id="email-list-heading">
                  <span id="email-folder-title">Inbox</span>
                  <span id="email-count" class="email-count-badge" aria-label="email count">0</span>
                </h3>
              </div>
              <div class="email-search-container">
                <input type="text" id="email-search" class="email-search-input" placeholder="Search emails..." aria-label="Search emails" />
                <button id="email-search-clear" class="email-search-clear" aria-label="Clear search" style="display: none;">×</button>
              </div>
            </div>
            <div class="email-list-container">
              <div id="email-list" class="email-list" tabindex="0" aria-describedby="email-list-help">
                <!-- Email rows will be populated here -->
                <div class="email-list-placeholder">
                  <div class="placeholder-icon" aria-hidden="true">📧</div>
                  <div class="placeholder-text">
                    <p>Select a persona to view emails</p>
                  </div>
                </div>
              </div>
              <div id="email-list-help" class="sr-only">Use arrow keys to navigate emails, Enter to select, R to refresh, I for Inbox, S for Sent</div>
            </div>
          </div>

          <!-- Email Detail Pane -->
          <div class="email-detail-pane" role="region" aria-labelledby="email-detail-heading">
            <div class="email-detail-container">
              <div id="email-detail" class="email-detail-view" aria-live="polite">
                <!-- Email detail content will be populated here -->
                <div class="email-detail-placeholder">
                  <div class="placeholder-icon" aria-hidden="true">✉️</div>
                  <div class="placeholder-text">
                    <h3 id="email-detail-heading">No email selected</h3>
                    <p>Select an email from the list to view its contents</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Chat Tab -->
    <section id="tab-chat" class="tabbed-section" style="display: none;" role="tabpanel" aria-labelledby="tab-chat-button">
      <h2 id="chat-tab-heading">Chat</h2>
      
      <!-- Chat Client Header -->
      <div class="chat-client-header" role="toolbar" aria-label="Chat client controls">
        <div class="chat-client-controls">
          <div class="form-group">
            <label for="chat-person-select">Persona</label>
            <select id="chat-person-select" aria-describedby="chat-person-help">
              <option value="">Select a persona...</option>
            </select>
            <div id="chat-person-help" class="sr-only">Choose which persona's chat conversations to view</div>
          </div>
        </div>
        
        <div class="chat-client-actions">
          <button id="chat-sidebar-toggle" class="chat-sidebar-toggle" aria-describedby="chat-sidebar-toggle-help">
            <span class="toggle-icon" aria-hidden="true">☰</span> Menu
          </button>
          <div id="chat-sidebar-toggle-help" class="sr-only">Toggle conversation sidebar</div>
          <button id="chat-refresh-btn" class="secondary" aria-describedby="chat-refresh-help">
            <span aria-hidden="true">🔄</span> Refresh
          </button>
          <div id="chat-refresh-help" class="sr-only">Refresh chat conversations</div>
          <div class="chat-status-indicator" role="status" aria-live="polite">
            <span id="chat-last-refresh">Never refreshed</span>
          </div>
        </div>
      </div>

      <!-- Chat Client Body - Two Pane Layout -->
      <div class="chat-client-body" role="main" aria-label="Chat client interface">
        <!-- Mobile sidebar overlay -->
        <div class="chat-sidebar-overlay" id="chat-sidebar-overlay" aria-hidden="true"></div>
        <div class="chat-client-layout" id="chat-client-layout">
          <!-- Chat Sidebar Pane -->
          <div class="chat-sidebar-pane" role="region" aria-labelledby="chat-sidebar-heading">
            <div class="chat-sidebar">
              <div class="chat-sidebar-header">
                <h3 id="chat-sidebar-heading" class="sr-only">Conversations</h3>
                <div class="chat-search-container">
                  <input type="text" id="chat-search" class="chat-search-input" placeholder="Search conversations..." aria-label="Search conversations" />
                  <button id="chat-search-clear" class="chat-search-clear" aria-label="Clear search" style="display: none;">×</button>
                </div>
              </div>
              <div class="chat-sidebar-content">
                <div class="conversation-section" id="rooms-section">
                  <h4 class="section-title">
                    <span class="section-icon" aria-hidden="true">#</span>
                    Rooms 
                    <span class="section-count" id="rooms-count">(0)</span>
                  </h4>
                  <div class="conversation-list" id="chat-rooms-list" role="list" aria-label="Chat rooms">
                    <!-- Room conversation items will be populated here -->
                  </div>
                </div>
                <div class="conversation-section" id="dms-section">
                  <h4 class="section-title">
                    <span class="section-icon" aria-hidden="true">@</span>
                    Direct Messages 
                    <span class="section-count" id="dms-count">(0)</span>
                  </h4>
                  <div class="conversation-list" id="chat-dms-list" role="list" aria-label="Direct messages">
                    <!-- DM conversation items will be populated here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Chat Message Pane -->
          <div class="chat-message-pane" role="region" aria-labelledby="chat-message-heading">
            <div class="chat-message-view">
              <div class="chat-message-header">
                <div class="conversation-title">
                  <h3 id="chat-message-heading" class="conversation-name">Select a conversation</h3>
                  <div class="conversation-meta">
                    <span class="participant-list"></span>
                    <span class="message-count"></span>
                  </div>
                </div>
                <div class="message-actions">
                  <div class="message-search-container">
                    <input type="text" id="message-search" class="message-search" placeholder="Search in conversation..." aria-label="Search messages in current conversation" />
                    <div class="message-search-controls" id="message-search-controls" style="display: none;">
                      <span class="search-results-count" id="search-results-count"></span>
                      <button id="search-prev-btn" class="search-nav-btn" aria-label="Previous search result" title="Previous (Shift+Enter)">↑</button>
                      <button id="search-next-btn" class="search-nav-btn" aria-label="Next search result" title="Next (Enter)">↓</button>
                      <button id="search-clear-btn" class="search-clear-btn" aria-label="Clear search" title="Clear (Escape)">✕</button>
                    </div>
                  </div>
                  <button id="message-refresh-btn" class="message-refresh-btn secondary" aria-label="Refresh messages">🔄</button>
                </div>
              </div>
              
              <div class="chat-message-content">
                <div class="message-thread" id="message-thread" role="log" aria-live="polite" aria-label="Message thread">
                  <!-- Message bubbles will be populated here -->
                  <div class="message-thread-placeholder">
                    <div class="placeholder-icon" aria-hidden="true">💬</div>
                    <div class="placeholder-text">
                      <h4>No conversation selected</h4>
                      <p>Select a conversation from the sidebar to view messages</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="chat-message-footer">
                <div class="message-status">
                  Last updated: <span id="chat-message-last-refresh">Never</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Email Modal Viewer -->
  <div id="email-modal" class="modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <div class="modal-header">
        <div class="modal-title" id="email-modal-subject">Subject</div>
        <button id="email-modal-close" class="secondary">Close</button>
      </div>
      <div class="modal-body" id="email-modal-body"></div>
    </div>
  </div>

  <script src="/static/js/dashboard.js"></script>
</body>
</html>
